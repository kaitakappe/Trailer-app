# 第1号様式（組立車等届出書）発行機能 - 詳細説明

## 概要

このアプリケーションは、トレーラーの各種計算結果から運輸局への申請書類「第1号様式（組立車等届出書）」を自動的に記入・発行する機能を提供します。

## 主な特徴

### 1. 自動データ収集

以下の計算タブから必要なデータを自動的に収集します：

- **重量計算書**: 車両重量、前軸重、後軸重
- **トレーラ諸元**: 寸法情報（長さ、幅、高さ、ホイールベース、トレッド）
- **車軸強度計算書**: 車軸数
- その他の計算結果も必要に応じて参照

### 2. 柔軟な入力方式

- **自動入力**: ボタン1つで計算結果から自動記入
- **手動入力**: 全フィールドが手動編集可能
- **混合入力**: 自動入力後、不足項目を手動で補完

### 3. プレビュー機能

PDF発行前に記入内容をテキスト形式でプレビュー可能

### 4. テンプレートPDF対応

- 既存のテンプレートPDFがあればオーバーレイ方式で記入
- テンプレートがなくても新規PDFを作成
- 複数の場所からテンプレートを自動検索

## 使用手順

### ステップ1: 計算の実行

まず、各計算タブで必要な計算を実行します：

1. **重量計算書**: 車両の重量配分を計算
2. **トレーラ諸元**: トレーラーの基本諸元を入力・計算
3. **車軸強度計算書**: 車軸の強度を確認
4. その他必要な計算を実行

### ステップ2: 第1号様式タブを開く

タブバーから「第1号様式（組立車等届出書）」を選択します。

### ステップ3: 自動入力

「計算結果から自動入力」ボタンをクリックします。

自動的に以下の項目が記入されます：

- **寸法情報**
  - 長さ (mm)
  - 幅 (mm)
  - 高さ (mm)
  - ホイールベース (mm)
  - トレッド（前/後） (mm)

- **重量情報**
  - 車両重量 (kg)
  - 車両総重量 (kg)
  - 前軸重 (kg)
  - 後軸重 (kg)

- **車軸情報**
  - 車軸数

- **車両種別**
  - 自動的に「組立車（トレーラ）」と設定

### ステップ4: 手動入力・修正

以下の項目は手動で入力が必要です：

- **申請者情報**
  - 氏名又は名称
  - 住所
  - 申請日（デフォルトで今日の日付が入力済み）

- **車両基本情報**
  - 自動車の名称
  - 型式
  - その他必要な情報

- **備考**
  - 追加で記載したい事項

### ステップ5: プレビュー確認

「プレビュー」ボタンをクリックして、記入内容を確認します。

別ウィンドウにテキスト形式で表示されます。

### ステップ6: PDF発行

「PDF発行...」ボタンをクリックして、保存先を指定します。

PDFファイルが生成され、指定した場所に保存されます。

## テンプレートPDFについて

### テンプレートの配置場所

アプリケーションは以下の順序でテンプレートPDFを検索します：

1. `デスクトップ/2025-1119-九州運輸局より/申請書等/【基本】組立車　第１号様式.pdf`
2. `ドキュメント/2025-1119-九州運輸局より/申請書等/【基本】組立車　第１号様式.pdf`
3. `プロジェクトフォルダ/templates/【基本】組立車　第１号様式.pdf`
4. `現在のディレクトリ/【基本】組立車　第１号様式.pdf`

### テンプレートの使用

- **テンプレートあり**: 既存のフォームにデータをオーバーレイ
- **テンプレートなし**: 新規にPDFを作成（全項目を記載）

### テンプレート座標の調整

テンプレートPDFを使用する場合、記入位置の調整が必要な場合があります。

`lib/form_issuer.py`の`_generate_with_template`関数内で座標を調整できます：

```python
# 例: 申請者名の位置を調整
if data.applicant_name:
    c.drawString(150, height - 150, data.applicant_name)  # X=150, Y=height-150
```

## プロジェクトファイルへの保存

### 保存内容

第1号様式の入力内容は、プロジェクトファイル（.json）に自動的に保存されます：

- メニュー > ファイル > プロジェクト保存（Ctrl+S）

### 読み込み

保存したプロジェクトを開くと、第1号様式の入力内容も復元されます：

- メニュー > ファイル > プロジェクトを開く（Ctrl+O）

## 一括出力

### 総合書類一括発行

メニュー > ファイル > 総合書類一括発行（Ctrl+E）で、全ての計算書類と第1号様式を一括でPDF発行できます。

## トラブルシューティング

### 自動入力がうまくいかない

**原因**: 各計算タブで計算が実行されていない

**解決策**: 各計算タブで「計算実行」ボタンをクリックしてから、自動入力を試してください

### PDFが発行されない

**原因1**: ReportLabがインストールされていない

**解決策**: `pip install reportlab`を実行

**原因2**: PyPDF2がインストールされていない（テンプレート使用時）

**解決策**: `pip install PyPDF2`を実行

### テンプレートが見つからない

**原因**: テンプレートPDFが検索パスにない

**解決策**: 
- テンプレートPDFを検索パスのいずれかに配置
- または、テンプレートなしでPDFを新規作成（自動的にフォールバック）

### 記入位置がずれる（テンプレート使用時）

**原因**: テンプレートPDFのレイアウトと座標が合っていない

**解決策**: 
1. `lib/form_issuer.py`を開く
2. `_generate_with_template`関数を編集
3. `c.drawString(x, y, text)`の座標(x, y)を調整

## 技術仕様

### データ構造

`Form1Data`クラスが全ての記入項目を保持：

```python
class Form1Data:
    applicant_name: str          # 申請者名
    applicant_address: str       # 住所
    application_date: str        # 申請日
    vehicle_type: str            # 車両種別
    vehicle_name: str            # 車両名称
    vehicle_model: str           # 型式
    length: str                  # 長さ (mm)
    width: str                   # 幅 (mm)
    height: str                  # 高さ (mm)
    # ... その他の項目
```

### 自動収集関数

`collect_calculation_data(panels)`: 全パネルから計算結果を収集

`auto_fill_form1_data(collected)`: 収集データからForm1Dataを生成

### PDF生成関数

`generate_form1_pdf(data, output_path, template_path)`: PDFを生成

## カスタマイズ

### フィールドの追加

新しいフィールドを追加する場合：

1. `lib/form_issuer.py`の`Form1Data`クラスにプロパティを追加
2. `Form1Panel`クラスに入力フィールドを追加
3. `_collect_form_data`メソッドで値を取得
4. `get_state`/`set_state`メソッドに保存・復元処理を追加
5. PDF生成関数にレンダリング処理を追加

### 自動収集ロジックのカスタマイズ

`lib/form_issuer.py`の`collect_calculation_data`関数を編集して、収集する計算結果を変更できます。

## まとめ

この機能により、手作業での転記ミスを防ぎ、申請書類作成の効率が大幅に向上します。

計算から申請まで、一貫したワークフローで作業できます。
